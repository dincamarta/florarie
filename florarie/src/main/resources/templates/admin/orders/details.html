<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Admin - Detalii comandă</title>
</head>
<body>

<h1>Comandă #<span th:text="${order.id}"></span></h1>

<p>
    <a th:href="@{/admin/orders}">Înapoi la comenzi</a> |
    <a th:href="@{/admin/flowers}">Admin - Flori</a>
</p>

<p><b>Status curent:</b> <span th:text="${order.status}"></span></p>
<p><b>User:</b> <span th:text="${order.user != null ? order.user.email : 'N/A'}"></span></p>
<p><b>Adresă:</b> <span th:text="${order.deliveryAddress}"></span></p>
<p><b>Telefon:</b> <span th:text="${order.phone}"></span></p>
<p><b>Total:</b> <span th:text="${order.total}"></span></p>

<h3>Schimbă status</h3>
<form th:action="@{/admin/orders/{id}/status(id=${order.id})}" method="post">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

    <select name="status">
        <option th:each="s : ${allStatuses}"
                th:value="${s}"
                th:text="${s}"
                th:selected="${s == order.status}">
        </option>
    </select>

    <button type="submit">Salvează</button>
</form>

<h3>Produse</h3>
<table border="1" cellpadding="6">
    <thead>
    <tr><th>Floare</th><th>Preț</th><th>Cant.</th><th>Total</th></tr>
    </thead>
    <tbody>
    <tr th:each="it : ${order.items}">
        <td th:text="${it.flowerName}"></td>
        <td th:text="${it.unitPrice}"></td>
        <td th:text="${it.quantity}"></td>
        <td th:text="${it.lineTotal}"></td>
    </tr>
    </tbody>
</table>
<h3>Etape</h3>

<div th:if="${#lists.isEmpty(steps)}">
    <p>Nu există etape pentru această comandă.</p>
    <form th:action="@{/admin/orders/{id}/steps/init(id=${order.id})}" method="post">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <button type="submit">Inițializează etape</button>
    </form>
</div>

<table border="1" cellpadding="6">
    <thead>
    <tr>
        <th>Etapă</th>
        <th>Stare</th>
        <th>Începe la</th>
        <th>Trebuie gata la</th>
        <th></th>
    </tr>
    </thead>

    <tbody>
    <tr th:each="s : ${steps}">
        <td th:text="${s.name}"></td>
        <td th:text="${s.done ? 'Finalizată' : 'În așteptare'}"></td>

        <td th:text="${planByName[s.name] != null ? #temporals.format(planByName[s.name].startAt(), 'yyyy-MM-dd HH:mm:ss') : '—'}"></td>
        <td th:text="${planByName[s.name] != null ? #temporals.format(planByName[s.name].dueAt(), 'yyyy-MM-dd HH:mm:ss') : '—'}"></td>

        <td>
            <form th:action="@{/admin/orders/{oid}/steps/{sid}/toggle(oid=${order.id}, sid=${s.id})}" method="post" style="display:inline;">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button type="submit" th:text="${s.done ? 'Marchează nefinalizată' : 'Finalizează'}"></button>
            </form>
        </td>
    </tr>
    </tbody>
</table>


<p>
    <b>Deadline:</b>
    <span th:text="${order.requiredBy != null ? order.requiredBy : '—'}">—</span>
</p>

<form th:action="@{/admin/orders/{id}/deadline(id=${order.id})}" method="post">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

    <input type="datetime-local" name="requiredBy"
           th:value="${order.requiredBy != null ? #temporals.format(order.requiredBy, 'yyyy-MM-dd''T''HH:mm') : ''}"/>

    <button type="submit">Salvează deadline</button>
</form>


</body>
</html>
